---
layout: hexo
title: MySQL连接数优化
date: 2017-08-03 20:53:54
tags:
---

问题
---

在使用Tomcat监听器进行定时（每0.5秒）扫描任务表的时候，发现测试数据库的连接数动不动就爆满，提示"to many connection"，连接数过多。

配置
---
以下是阿里云上MySQL（测试版）的基本配置信息
设备 参数
CPU 3核
内存 240M
连接数 60
ips 200

原因
---

硬件原因
1、数据库配置很低
2、连接暂存时间设置过长

软件原因
1、在每次执行扫描连接后，没有及时释放连接
java autocloseable
2、部分服务写得不够简练，性能太差


解决
---

硬件方面
1、由于是测试数据库，研发团队人数不多，进行升级是没有必要的
2、修改数据库的连接数，

nteractive_timeout
---
针对交互式连接，


wait_timeout
---
针对非交互式连接。

所谓的交互式连接，即在mysql_real_connect()函数中使用了CLIENT_INTERACTIVE选项。     

说得直白一点，通过mysql客户端连接数据库是交互式连接，通过jdbc连接数据库是非交互式连接。 

在连接启动的时候，根据连接的类型，来确认会话变量wait_timeout的值是继承于全局变量wait_timeout，还是interactive_timeout。

软件方面
1、修改数据库连接的代码，确保每次通信完毕就手动释放连接（java autoclose 是java虚拟机回收的，不代表数据库回自动关闭连接）
2、根据慢日志找出性能较差的服务，重构代码


